generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(uuid())
  pokePokeId      String           @unique
  name            String
  passwordHash    String
  role            String           @default("USER")
  isBlacklisted   Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  cardCollection  CardCollection?
  sentTradeOffers      TradeOffer[]     @relation("Sender")
  receivedTradeOffers  TradeOffer[]     @relation("Receiver")
  sentMessages         Message[]        @relation("Sender")
}

model Pack {
  id          String   @id @default(uuid())
  name        String   @unique
  code        String?  @unique
  releaseDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cards Card[]
}

model Card {
  id          String   @id @default(uuid())
  packId      String
  name        String   @unique
  description String?
  rarity      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  pack             Pack             @relation(fields: [packId], references: [id], onDelete: Restrict)
  collectionItems  CollectionItem[]
  tradeOfferCards  TradeOfferCard[]

  @@index([packId])
}

model CardCollection {
  id        String   @id @default(uuid())
  userId    String   @unique
  items     CollectionItem[]

  user      User     @relation(fields: [userId], references: [id])
}

model CollectionItem {
  id               String         @id @default(uuid())
  collectionId     String
  cardId           String
  cardType         String         // WANTED or OFFERED
  quantity         Int            @default(1)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  collection       CardCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  card             Card           @relation(fields: [cardId], references: [id], onDelete: Restrict)

  @@unique([collectionId, cardId, cardType])
  @@index([cardId])
}

model TradeOffer {
  id          String           @id @default(uuid())
  senderId    String
  receiverId  String
  status      String           // PENDING, ACCEPTED, REJECTED, CANCELED
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  sender      User             @relation("Sender", fields: [senderId], references: [id])
  receiver    User             @relation("Receiver", fields: [receiverId], references: [id])
  
  details     TradeOfferCard[]
  messages    Message[]
}

model TradeOfferCard {
  id            String     @id @default(uuid())
  tradeOfferId  String
  cardId        String
  type          String     // WANTED (sender wants), GIVEN (sender gives)
  quantity      Int        @default(1)
  createdAt     DateTime   @default(now())
  
  tradeOffer    TradeOffer @relation(fields: [tradeOfferId], references: [id], onDelete: Cascade)
  card          Card       @relation(fields: [cardId], references: [id], onDelete: Restrict)

  @@index([tradeOfferId])
  @@index([cardId])
}

model Message {
  id            String     @id @default(uuid())
  tradeOfferId  String
  senderId      String
  content       String
  createdAt     DateTime   @default(now())
  
  tradeOffer    TradeOffer @relation(fields: [tradeOfferId], references: [id])
  sender        User       @relation("Sender", fields: [senderId], references: [id])
}
